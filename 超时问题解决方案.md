# 超时问题解决方案

## 问题诊断

从Vercel日志可以看到：
- ✅ 环境变量配置正确
- ✅ 图片转换成功
- ✅ API调用已发起
- ❌ **请求在50秒后超时（AbortError）**

## 根本原因

1. **Vercel免费版函数超时限制：10秒**
   - 免费版：最大10秒
   - Pro版：最大60秒

2. **豆包API响应时间较长**
   - 图片识别需要时间
   - 大图片处理更慢
   - 当前图片base64长度：363,007字符（约354KB）

3. **超时设置冲突**
   - AbortController设置了50秒超时
   - 但Vercel函数在10秒时就已超时

## 解决方案

### 方案1：升级到Vercel Pro（推荐）

**优点：**
- 支持60秒函数超时
- 可以处理更大的图片
- 更好的性能

**步骤：**
1. 登录 Vercel Dashboard
2. 进入项目设置
3. 升级到 Pro 计划
4. 修改 `app/api/analyze/route.ts` 中的 `maxDuration = 60`
5. 修改 `lib/doubao-api.ts` 中的超时时间为 `55000`（55秒）

### 方案2：优化图片大小（临时方案）

**在客户端压缩图片：**

1. 修改 `components/ImageUpload.tsx`，添加图片压缩功能
2. 限制图片最大尺寸（例如：1920x1920）
3. 压缩质量（例如：0.8）

**优点：**
- 不需要升级
- 减少API处理时间
- 提升用户体验

### 方案3：优化提示词（已实施）

**已优化：**
- 简化提示词，减少token数量
- 使用更简洁的JSON格式示例
- 减少不必要的说明文字

### 方案4：使用流式响应（高级）

**实现思路：**
- 使用Server-Sent Events (SSE)
- 分段返回结果
- 避免单次长时间请求

## 当前代码优化

### 已完成的优化：

1. ✅ 将AbortController超时改为8秒（适配Vercel免费版）
2. ✅ 简化提示词，减少token数量
3. ✅ 添加图片大小警告
4. ✅ 优化错误处理

### 建议的下一步：

1. **立即方案**：压缩上传的图片
2. **长期方案**：升级到Vercel Pro

## 图片压缩实现示例

可以在 `components/ImageUpload.tsx` 中添加：

```typescript
function compressImage(file: File, maxWidth: number = 1920, quality: number = 0.8): Promise<File> {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx?.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          if (blob) {
            const compressedFile = new File([blob], file.name, {
              type: file.type,
              lastModified: Date.now(),
            });
            resolve(compressedFile);
          } else {
            resolve(file);
          }
        }, file.type, quality);
      };
      img.src = e.target?.result as string;
    };
    reader.readAsDataURL(file);
  });
}
```

## 测试建议

1. **测试小图片**（< 500KB）
   - 应该能在10秒内完成

2. **测试中等图片**（500KB - 1MB）
   - 可能需要压缩

3. **测试大图片**（> 1MB）
   - 必须压缩或升级Vercel Pro

## 监控建议

在Vercel Dashboard中监控：
- 函数执行时间
- 超时频率
- 错误率

如果超时频繁，建议升级到Pro计划。


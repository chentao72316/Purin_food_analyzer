# 故障排查指南

## 500错误 - 分析失败

当遇到"分析失败"的500错误时，请按以下步骤排查：

## 1. 检查服务器日志

在运行 `npm run dev` 的终端中查看详细错误信息：

```bash
# 查看终端输出，应该会显示：
- "正在调用豆包API..."
- "API响应状态: XXX"
- "豆包API原始响应: ..."
- "分析失败: ..."
```

## 2. 常见错误原因

### 错误1: API密钥无效
**症状：** 401 Unauthorized 或 403 Forbidden

**解决方法：**
1. 检查 `.env.local` 文件是否存在
2. 确认 `ARK_API_KEY` 是否正确
3. 确认 `ARK_ENDPOINT_ID` 是否正确
4. 重启开发服务器（修改环境变量后需要重启）

### 错误2: 网络连接问题
**症状：** ECONNREFUSED, ETIMEDOUT, 或 fetch failed

**解决方法：**
1. 检查网络连接
2. 确认可以访问 `https://ark.cn-beijing.volces.com`
3. 检查防火墙设置
4. 如果在公司网络，可能需要配置代理

### 错误3: API响应格式不匹配
**症状：** JSON解析失败，或"模型返回数据格式错误"

**解决方法：**
1. 查看服务器日志中的"豆包API原始响应"
2. 检查响应格式是否符合预期
3. 可能需要调整 `lib/doubao-api.ts` 中的解析逻辑

### 错误4: 请求超时
**症状：** 长时间无响应，然后超时

**解决方法：**
1. 豆包API可能需要较长时间处理
2. 检查图片大小（建议小于5MB）
3. 尝试使用更小的图片

### 错误5: 调用频率限制
**症状：** 429 Too Many Requests

**解决方法：**
1. 等待一段时间后重试
2. 检查API调用频率限制
3. 避免短时间内多次调用

## 3. 调试步骤

### 步骤1: 检查环境变量

```bash
# 在项目根目录检查 .env.local 文件
cat .env.local

# 应该包含：
# ARK_API_KEY=your_api_key
# ARK_ENDPOINT_ID=your_endpoint_id
# ARK_API_URL=https://ark.cn-beijing.volces.com/api/v3/responses
```

### 步骤2: 测试API连接

可以在浏览器控制台或使用curl测试：

```bash
curl -X POST https://ark.cn-beijing.volces.com/api/v3/responses \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"YOUR_ENDPOINT_ID","input":[{"role":"user","content":[{"type":"input_text","text":"测试"}]}]}'
```

### 步骤3: 查看详细日志

在 `lib/doubao-api.ts` 中已经添加了详细的日志输出：
- API调用开始
- API响应状态
- 原始响应内容
- JSON解析过程
- 最终结果

查看终端输出可以帮助定位问题。

### 步骤4: 检查图片

1. **图片格式：** 只支持 JPG、PNG、WEBP
2. **图片大小：** 建议小于5MB，最大10MB
3. **图片内容：** 确保图片包含清晰可见的食物

## 4. 快速检查清单

- [ ] `.env.local` 文件存在且配置正确
- [ ] 开发服务器已重启（修改环境变量后）
- [ ] 网络连接正常
- [ ] 图片格式和大小符合要求
- [ ] 查看终端日志中的详细错误信息
- [ ] API密钥和Endpoint ID正确

## 5. 获取帮助

如果以上步骤都无法解决问题，请提供以下信息：

1. **终端日志：** 完整的错误堆栈和日志输出
2. **浏览器控制台：** 网络请求的详细信息
3. **环境信息：** Node.js版本、操作系统
4. **错误截图：** 浏览器控制台的错误信息

## 6. 临时解决方案

如果API持续失败，可以：

1. **检查API服务状态：** 确认豆包API服务是否正常
2. **尝试其他图片：** 使用不同的图片测试
3. **降低图片质量：** 压缩图片后再上传
4. **等待后重试：** 如果是频率限制，等待一段时间后重试

